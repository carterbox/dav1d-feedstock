# library version is different from project version
# Check 'meson.build' upstream in every release!
context:
  version: 1.5.0
  so_name: 7.0.0
  so_name_major: ${{ so_name | split('.') | first }}

recipe:
  name: dav1d-split
  version: ${{ version }}

cache:

  source:
    - url: https://code.videolan.org/videolan/dav1d/-/archive/${{ version }}/dav1d-${{ version }}.tar.gz
      sha256: 78b15d9954b513ea92d27f39362535ded2243e1b0924fde39f37a31ebed5f76b

  build:
    script:
      - if: unix
        then: cache.sh
      - if: win
        then: cache.bat

  requirements:
    build:
      - ${{ compiler('c') }}
      - ${{ stdlib("c") }}
      - meson >=0.49
      - ninja
      - nasm >=2.14
      - pkg-config

outputs:
  - package:
      name: libdav1d${{ so_name_major }}
    build:
      files:
        include:
          - if: win
            then: Library/bin/*.dll
          - if: osx
            then: lib/lib*.*.dylib
          - if: linux
            then: lib/*.so.*
    tests:
      - script:
          - if: linux
            then:
              - test -f ${PREFIX}/lib/libdav1d$SHLIB_EXT.${{ so_name_major }}
              - test -f ${PREFIX}/lib/libdav1d$SHLIB_EXT.${{ so_name }}
          - if: osx
            then:
              - test -f ${PREFIX}/lib/libdav1d.${{ so_name_major }}$SHLIB_EXT
              - test ! -f ${PREFIX}/lib/libdav1d.${{ so_name }}$SHLIB_EXT
          - if: unix
            then:
              - test ! -f ${PREFIX}/bin/dav1d
              - test ! -f ${PREFIX}/lib/libdav1d$SHLIB_EXT
              - test ! -f ${PREFIX}/lib/pkgconfig/dav1d.pc
              - test ! -f ${PREFIX}/include/dav1d/dav1d.h
          - if: win
            then:
              - if not exist %PREFIX%\\Library\\bin\\dav1d.dll exit 1
              - if exist %PREFIX%\\Library\\bin\\dav1d exit 1
              - if exist %PREFIX%\\Library\\lib\\dav1d.lib exit 1
              - if exist %PREFIX%\\Library\\include\\dav1d\\dav1d.h exit 1
              - if exist %PREFIX%\\Library\\lib\\pkgconfig\\dav1d.pc exit 1

about:
  summary: dav1d is the fastest AV1 decoder on all platforms
  license: BSD-2-Clause
  license_file: COPYING
  homepage: https://code.videolan.org/videolan/dav1d

extra:
  feedstock-name: dav1d
  recipe-maintainers:
    - carterbox
    - jaimergp

